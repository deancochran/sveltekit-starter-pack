<script lang="ts">
	import LoadingIcon from '$lib/components/LoadingIcon.svelte';
	import type { Infer, SuperValidated } from 'sveltekit-superforms';
	import { focusTrap } from '@skeletonlabs/skeleton';
	import { superForm } from 'sveltekit-superforms/client';
	import PasswordInput from './inputs/PasswordInput.svelte';
	import { AlertCircle } from 'lucide-svelte';
	import Button from '$lib/components/Button.svelte';
	import { cancel_user_subscription_schema, type CancelUserSubscription } from '$lib/schemas';
	import { zod } from 'sveltekit-superforms/adapters';
	import InputLabel from './inputs/InputLabel.svelte';

	export let form_data: SuperValidated<Infer<CancelUserSubscription>>;

	const superform = superForm(form_data, {
		id: 'cancelSubscription',
		applyAction: true,
		invalidateAll: true,
		resetForm: false,
		validators: zod(cancel_user_subscription_schema),
		delayMs: 0,
		timeoutMs: 8000
	});
	const { form, errors, constraints, enhance, delayed } = superform;
	let isFocused: boolean = false;
</script>

<div class="card">
	<header class="card-header flex justify-center">
		<h1>Cancel Your Subscription</h1>
	</header>
	<section class="p-4 space-y-4">
		<aside class="alert variant-ghost-warning p-4">
			<div class="inline-flex space-x-2">
				<AlertCircle />
				<h3 class="h3 font-bold flex-inline">Warning</h3>
			</div>
			<div class="alert-message">
				<p>
					Canceling your subscription will cause an immediate stop to all your subscriber
					privileges.
				</p>
			</div>
		</aside>
		<form
			id="cancelSubscription"
			use:focusTrap={isFocused}
			method="POST"
			action="/settings/?/cancelSubscription"
			use:enhance
		>
			<InputLabel label="password">
				<PasswordInput {superform} field="password" />
			</InputLabel>
		</form>
	</section>
	<footer class="w-full card-footer flex flex-wrap items-end align-middle justify-end gap-2">
		{#if $delayed}
			<LoadingIcon />
		{:else}
			<Button
				shadow="shadow-md"
				color="variant-filled-error"
				form="cancelSubscription"
				type="submit">Cancel Subscription</Button
			>
		{/if}
	</footer>
</div>
